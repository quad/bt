#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'bt'
require 'yaml'

opts = Trollop::options do
  banner <<-EOS
  Shows canonical stage definition for commit.

Usage: bt-stages [OPTS...] [DIRECTORY]
  EOS

  opt :commit, 'Commit to generate stage definition from', :default => 'HEAD'
end

directory = ARGV.shift || Dir.pwd

r = BT::Repository.new directory

specification = (r.commit(opts[:commit]).tree / 'stages').blobs.map do |blob|
  specification = YAML.load(blob.data)
  [blob.basename, ({'needs' => [], 'results' => [], 'run' => ''}.merge(specification))]
end

y Hash[specification]
