#!/usr/bin/env ruby

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'bt'
require 'yaml'

opts = Trollop::options do
  banner <<-EOS
Shows build results for head.

Usage:
\tbt results
  EOS
  opt :debug, 'Debugging text scrolls'
  opt :uri, 'Give the results for a specified URI', :short => :u, :type => :string, :default => Dir.pwd
  opt :commit, 'Commit to get results for', :default => 'HEAD'
end

include BT::Cli

Grit.debug = true if opts[:debug]

BT::Repository.mirror(opts[:uri]) do |r|
  r.update
  commit = r.commit(opts[:commit])

  stage_definition = YAML.load(`#{find_command :stages} --commit #{commit.sha} #{r.path}`)

  pipeline = BT::Pipeline.new commit, stage_definition

  puts "Results (#{commit.sha}):\n\n"

  pipeline.stages.each do |stage|
    puts "#{stage.name}: #{stage.result}"
  end
end

